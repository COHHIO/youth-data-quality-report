---
title: Data Quality Report
subtitle: TODO
execute:
  echo: false
params:
  period_start_date: "2025-07-01"
  period_end_date: "2025-09-30"
---

```{r set-default-params-for-interactive-development}
# Set default params for interactive development
if (!exists("params")) {
    params <- list(
        period_start_date = "2025-07-01",
        period_end_date = "2025-09-30"
    )
}
```

```{r make-params-available-to-included-documents}
# Make params available to included documents
period_start_date <- params$period_start_date
period_end_date <- params$period_end_date
```

{{< include /qmd/_00_00_constants.qmd >}}

{{< include /qmd/_00_01_utils.qmd >}}

{{< include /qmd/_00_02_process_data.qmd >}}

## Universal Data Elements

There were `r nrow(enrollments_in_period)` enrollments between `r period_start_date` and `r period_end_date`.

```{r check-duplicated-enrollment-id}
#| results: asis
n_duplicated_enrollment_ids <- enrollments_in_period |>
    dplyr::count(enrollment_id) |>
    dplyr::filter(n > 1) |>
    nrow()

n_duplicated_enrollment_ids_string <- ifelse(
    n_duplicated_enrollment_ids == 0,
    "✅ There are no duplicated enrollment IDs.",
    paste0("❌ There are ", n_duplicated_enrollment_ids, " duplicated enrollment IDs.")
)

cat(n_duplicated_enrollment_ids_string)
```

### Social Security Number

SSN data is recorded in two fields:

- Social Security Number
- SSN Data Quality

```{r check-ssn-responses}
data_enrollment |>
    create_data_quality_table(
        response_column = "ssn_data_quality",
        combine_responses = FALSE,
        group_column = "ssn_length",
        group_column_label = "SSN Length",
        table_title = "SSN Data Quality and SSN Length"
    ) |>
    gt::cols_width(
        data_quality_status ~ gt::pct(49),
        gt::everything() ~ gt::pct(17)
    )
```

### Date of Birth

```{r check-age-range}
#| results: asis
min_age <- min(data_enrollment$age, na.rm = TRUE)
max_age <- max(data_enrollment$age, na.rm = TRUE)

cat(paste0("Participants reported ages ranging from ", min_age, " to ", max_age, " years."))
```

```{r check-missing-age}
#| results: asis
n_missing_age <- data_enrollment |>
    dplyr::filter(age_grouped == "Missing") |>
    nrow()

n_missing_age_string <- ifelse(
    n_missing_age == 0,
    "✅ All participants reported an age value.",
    paste0("⚠️ ", n_missing_age, " participant", ifelse(n_missing_age > 1, "s", ""), " reported no age value.")
)

cat(n_missing_age_string)
```

```{r check-age-distribution}
data_enrollment |>
    ggplot2::ggplot() +
    ggplot2::geom_histogram(
        mapping = ggplot2::aes(x = age),
        binwidth = 3,
        boundary = 0,
        closed = "left",
        fill = palette$light_blue,
        color = palette$navy_blue
    ) +
    ggplot2::scale_x_continuous(
        breaks = seq(
            floor(min(min_age, 0) / 3) * 3,
            ceiling(max_age / 3) * 3,
            3
        )
    ) +
    ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, 0.15))) +
    ggplot2::labs(
        title = "Participants by Age",
        x = "Age (Years)",
        y = "Count"
    ) +
    ggplot2::theme_bw()
```

### Race and Ethnicity

### Veteran Status

```{r check-veteran-status-responses}
data_enrollment |>
    create_data_quality_table(
        response_column = "veteran_status",
        group_column = "is_adult",
        group_column_label = "Adult",
        table_title = "Veteran Status Data Quality"
    )
```

### Relationship to Head of Household

The `r nrow(enrollments_in_period)` enrollments in this period came from `r dplyr::n_distinct(data_enrollment$household_id)` distinct households.

```{r check-one-head-of-household-per-household}
#| results: asis
distinct_n_hoh_per_h <- data_enrollment |>
    dplyr::summarise(
        n_hoh = sum(relationship_to_ho_h == "Self (head of household)"),
        .by = "household_id"
    ) |>
    dplyr::count(n_hoh) |>
    dplyr::pull(n_hoh)

distinct_n_hoh_per_h_filtered <- distinct_n_hoh_per_h[distinct_n_hoh_per_h != 1]

distinct_n_hoh_per_h_string <- ifelse(
    length(distinct_n_hoh_per_h) == 1 && distinct_n_hoh_per_h == 1,
    "✅ All households have exactly one head of household.",
    paste0("❌ Some households have an incorrect number of heads of household. Found households with ", paste0(distinct_n_hoh_per_h_filtered, collapse = ", "), " heads of household.")
)

cat(distinct_n_hoh_per_h_string)
```

```{r check-relationship-to-head-of-household-responses}
data_enrollment |>
    create_data_quality_table(
        response_column = "relationship_to_ho_h",
        no_response_values = c(
            "Data not collected",
            "Missing"
        ),
        table_title = "Relationship to Head of Household"
    )
```

```{r check-heads-of-household-age}
data_enrollment |>
    dplyr::filter(relationship_to_ho_h == "Self (head of household)") |>
    dplyr::count(age_grouped, .drop = FALSE) |>
    ggplot2::ggplot() +
    ggplot2::geom_bar(
        mapping = ggplot2::aes(
            x = age_grouped,
            y = n
        ),
        stat = "identity",
        fill = palette$light_blue,
        color = palette$navy_blue
    ) +
    ggplot2::geom_text(
        mapping = ggplot2::aes(
            x = age_grouped,
            y = n,
            label = ifelse(n == 0, "", n)
        ),
        hjust = -0.2
    ) +
    ggplot2::coord_flip() +
    ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = c(0, 0.15))) +
    ggplot2::labs(x = "Age (Years)", y = "Head of Household Count") +
    ggplot2::theme_bw()

```

### Prior Living Situation
```{r check-prior-living-situation-responses}
data_enrollment |>
    create_data_quality_table(
        response_column = "living_situation",
        group_column = "is_hoh_or_adult",
        group_column_label = "Head of Household and/or Adult",
        table_title = "Prior Living Situation"
    )
```

## Federal Partner Program Specific Data Elements

### RHY

#### Referral Source

```{r check-referral-source-responses}
data_enrollment |>
    create_data_quality_table(
        response_column = "referral_source",
        group_column = "is_hoh_or_adult",
        group_column_label = "Head of Household and/or Adult",
        table_title = "Referral Source"
    )
```

#### Formerly a Ward of Child Welfare/Foster Care Agency

```{r check-formerly-ward-of-child-welfare-foster-care-agency}
data_enrollment |>
    create_data_quality_table(
        response_column = "former_ward_child_welfare",
        group_column = "is_hoh_or_adult",
        group_column_label = "Head of Household and/or Adult",
        table_title = "Formerly a Ward of Child Welfare/Foster Care Agency"
    )
```

#### Formerly a Ward of Juvenile Justice System

```{r check-formerly-ward-of-juvenile-justice-system}
data_enrollment |>
    create_data_quality_table(
        response_column = "former_ward_juvenile_justice",
        group_column = "is_hoh_or_adult",
        group_column_label = "Head of Household and/or Adult",
        table_title = "Formerly a Ward of Juvenile Justice System"
    )
```
